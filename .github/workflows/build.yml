name: Build ARM Repo (Native)

on:
  push:
    branches: [ main ]
    paths:
      - 'packages/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-native:
    # ⚡ MAGIC LINE: Use GitHub's native ARM runner
    runs-on: ubuntu-24.04-arm
    
    # Run the entire job inside a clean Arch Linux container
    container:
      image: archlinux:base-devel
      options: --privileged # Required for some build tools
    
    env:
      GPG_KEY: ${{ secrets.GPG_SIGNING_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      
    steps:
      - name: Install System Prerequisites
        run: |
          # 1. Initialize Pacman
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm git sudo go
          
          # 2. Install 'yay' (or any AUR helper) to simplify dependency handling
          #    We build it manually once since we are in a bare container
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers
          su builder -c "git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin && cd /tmp/yay-bin && makepkg -si --noconfirm"

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Configure GPG
        run: |
          # Import Key
          su builder -c "mkdir -p ~/.gnupg && chmod 700 ~/.gnupg"
          su builder -c "echo '$GPG_KEY' | gpg --batch --import"
          
          # Get Key ID
          KEY_ID=$(su builder -c "gpg --list-secret-keys --with-colons" | grep fpr | head -n1 | cut -d: -f10)
          echo "KEY_ID=$KEY_ID" >> $GITHUB_ENV
          
          # Trust Key & Fix Agent
          echo "${KEY_ID}:6:" | su builder -c "gpg --import-ownertrust"
          su builder -c "echo 'allow-loopback-pinentry' >> ~/.gnupg/gpg-agent.conf"
          su builder -c "echo 'pinentry-mode loopback' >> ~/.gnupg/gpg.conf"
          su builder -c "gpgconf --kill gpg-agent"
          
          # Prime Passphrase (if set)
          if [ ! -z "$GPG_PASSPHRASE" ]; then
             echo "test" | su builder -c "gpg --batch --yes --passphrase '$GPG_PASSPHRASE' --pinentry-mode loopback --dry-run -s"
          fi

      - name: Detect Changed Packages
        id: changes
        run: |
          # Simple git diff to find which folders in 'packages/' changed
          # Native git works perfectly here
          git config --global --add safe.directory $GITHUB_WORKSPACE
          CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^packages/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          echo "Detected changes: $CHANGED"
          echo "list=$CHANGED" >> $GITHUB_OUTPUT

      - name: Build & Sign Packages
        if: steps.changes.outputs.list != ''
        run: |
          # Setup Repo Dir
          mkdir -p repo
          chown builder:builder repo
          
          # Load previous DB if exists (optional, otherwise start fresh)
          # wget -q https://leo-tocca.github.io/lt-aur/aarch64/lt-aur.db.tar.gz -O repo/lt-aur.db.tar.gz || true
          
          # Iterate changes
          for pkg in ${{ steps.changes.outputs.list }}; do
             if [ ! -d "packages/$pkg" ]; then continue; fi
             echo "Building $pkg..."
             
             # Copy PKGBUILD to builder home
             cp -r "packages/$pkg" "/home/builder/$pkg"
             chown -R builder:builder "/home/builder/$pkg"
             
             cd "/home/builder/$pkg"
             
             # ⚡ NATIVE BUILD with Internet Access!
             # We can run 'makepkg -s' and it will download deps automatically.
             # No "aur sync" complexity needed.
             su builder -c "makepkg -si --noconfirm --nocheck --sign --key ${{ env.KEY_ID }}"
             
             # Move results
             mv *.pkg.tar.zst* $GITHUB_WORKSPACE/repo/
             
             # Add to DB
             cd $GITHUB_WORKSPACE/repo
             su builder -c "repo-add --new --sign --key ${{ env.KEY_ID }} lt-aur.db.tar.gz *.pkg.tar.zst"
          done

      - name: Fix Permissions
        if: always()
        run: chown -R root:root repo

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: steps.changes.outputs.list != ''
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          destination_dir: aarch64
          keep_files: true  # Don't delete existing packages!
