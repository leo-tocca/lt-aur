name: Build AUR Repo with aurutils

on:
  push:
    branches: [ main ]
    paths:
      - 'packages‑list.yaml'
      - '.github/workflows/**'
  schedule:
    - cron: '0 0 * * 0' # weekly
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu‑latest
    env:
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
      REPO_NAME: ${{ github.repository }}
      REPO_OWNER: ${{ github.repository_owner }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install prerequisites
      run: |
        sudo pacman‑key --init
        sudo pacman‑key --populate archlinuxarm
        sudo pacman ‑Syu --noconfirm base-devel git aurutils systemd
        # enable systemd‑nspawn (aurutils uses it for clean chroot builds)
        sudo mkdir ‑p /etc/systemd/nspawn
        sudo systemctl enable systemd‑nspawn

    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_SIGNING_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mkdir ‑p ~/.gnupg
        echo "$GPG_PRIVATE_KEY" | gpg --batch --import
        # allow loopback pinentry for signing
        echo "allow‑loopback‑pinentry" >> ~/.gnupg/gpg‑agent.conf
        echo $GPG_PASSPHRASE | gpg --batch --passphrase‑fd 0 \
            --pinentry‑mode loopback --quick‑sign‑key $GPG_KEY_ID
        gpg --list‑secret‑keys

    - name: Parse package list
      id: pkgs
      run: |
        PACKAGES=$(yq e '.packages[]' packages‑list.yaml)
        echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

    - name: Prepare local repo dir
      run: |
        mkdir ‑p repo
        cd repo
        repo‑add custom.db.tar.gz  # create initial empty database

    - name: Sync & build AUR packages
      run: |
        aur sync \
          --chroot \
          --sign \
          --no‑view \
          --database‑dir repo \
          $PACKAGES

    - name: Commit built repo
      run: |
        git config user.name "github‑actions"
        git config user.email "actions@github.com"
        git add repo
        git commit ‑m "Update built AUR repo"
        git push

    - name: Prepare for Pages
      run: |
        mkdir ‑p _site/aarch64
        cp repo/* _site/aarch64/
        # generate pacman config
        cat > _site/myrepo.conf <<EOF
        [aurrepo]
        SigLevel = Required TrustedOnly
        Server = https://${REPO_OWNER}.github.io/${REPO_NAME}/aarch64
        EOF

    - name: Upload Pages artifact
      uses: actions/upload‑pages‑artifact@v3
      with:
        path: _site

  deploy:
    needs: build
    runs-on: ubuntu‑latest
    steps:
    - name: Deploy Pages
      uses: actions/deploy‑pages@v4
