name: Build lt-aur Repo

on:
  push:
    paths:
      - 'packages-list.yaml'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-arm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in Arch ARM Container
        uses: addnab/docker-run-action@v3
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          REPO_URL: "https://leo-tocca.github.io/lt-aur/aarch64"
        with:
          image: agners/archlinuxarm
          options: --platform linux/arm64 -v ${{ github.workspace }}:/workspace -e GPG_PRIVATE_KEY -e GPG_PASSPHRASE -e REPO_URL
          run: |
            # --- SETUP ---
            cd /workspace
            DB_NAME="lt-aur"
            
            # 1. CRITICAL FIX: DISABLE PACMAN SANDBOX
            # The 'Landlock' error happens because GitHub Actions doesn't support
            # the new Pacman 7.0 security isolation. We MUST disable it.
            # We append it to the end of the file to guarantee it works.
            echo "" >> /etc/pacman.conf
            echo "[options]" >> /etc/pacman.conf
            echo "DisableSandbox" >> /etc/pacman.conf
            
            # 2. Update System
            pacman-key --init
            pacman-key --populate archlinuxarm
            pacman -Syu --noconfirm base-devel git sudo wget
            
            # 3. Setup Builder User
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder
            chmod 0440 /etc/sudoers.d/builder
            
            # Prepare Repo Dir
            mkdir -p repo
            chown builder:builder repo
            
            # --- GPG SETUP ---
            echo "::group::Configuring GPG"
            su builder -c "mkdir -p ~/.gnupg && chmod 700 ~/.gnupg"
            su builder -c "echo 'allow-loopback-pinentry' >> ~/.gnupg/gpg-agent.conf"
            su builder -c "echo 'pinentry-mode loopback' >> ~/.gnupg/gpg.conf"
            su builder -c "gpgconf --kill gpg-agent"
            su builder -c "gpg --batch --import <(echo '$GPG_PRIVATE_KEY')"
            KEY_FINGERPRINT=$(su builder -c "gpg --list-secret-keys --with-colons" | grep fpr | head -n1 | cut -d: -f10)
            echo "${KEY_FINGERPRINT}:6:" | su builder -c "gpg --import-ownertrust"
            
            # Prime the agent with passphrase
            if [ ! -z "$GPG_PASSPHRASE" ]; then
               echo "test" | su builder -c "gpg --batch --yes --passphrase '$GPG_PASSPHRASE' --pinentry-mode loopback --dry-run -s --armor"
            fi
            echo "::endgroup::"

            # --- RESTORE/INIT DB ---
            echo "::group::Repo Initialization"
            cd repo
            if wget -q "$REPO_URL/$DB_NAME.db.tar.gz"; then
                echo "✅ Existing database downloaded."
                wget -q "$REPO_URL/$DB_NAME.db.tar.gz.sig" || true
            else
                echo "⚠️ No existing database found. Creating new."
                su builder -c "repo-add --sign --key $KEY_FINGERPRINT $DB_NAME.db.tar.gz"
            fi
            cd ..
            echo "::endgroup::"
            
            # --- PARSE PACKAGES ---
            if [ ! -f packages-list.yaml ]; then echo "No package list!"; exit 1; fi
            PACKAGES=$(grep '  -' packages-list.yaml | cut -d'-' -f2- | tr -d ' ' | xargs)
            echo "::group::Target Packages: $PACKAGES"
            
            # --- BUILD LOOP ---
            for pkg in $PACKAGES; do
                echo "--------------------------------------"
                echo "Building $pkg..."
                echo "--------------------------------------"
                
                # Clean start
                rm -rf "/home/builder/$pkg"
                
                # Clone directly from AUR
                su builder -c "git clone https://aur.archlinux.org/$pkg.git /home/builder/$pkg"
                
                cd "/home/builder/$pkg"
                
                # BUILD FIXES:
                # -A : Ignore architecture (Fixes 'albert is not available for aarch64')
                # -s : Sync deps (Now works because Sandbox is disabled)
                # -i : Install built package (Satisfies local deps)
                su builder -c "makepkg -siA --noconfirm --nocheck --sign --key $KEY_FINGERPRINT"
                
                if [ $? -eq 0 ]; then
                    # Move artifacts (pkg + sig) to repo
                    mv *.pkg.tar.zst* /workspace/repo/
                    
                    # Add to DB
                    cd /workspace/repo
                    su builder -c "repo-add --new --sign --key $KEY_FINGERPRINT --verify $DB_NAME.db.tar.gz *.pkg.tar.zst"
                else
                    echo "❌ Failed to build $pkg"
                    # We continue to next package
                fi
            done
            echo "::endgroup::"

      - name: Fix Permissions
        if: always()
        run: sudo chown -R $USER:$USER repo

      - name: Prepare Pages Site
        run: |
          mkdir -p _site/aarch64
          if [ -d "repo" ]; then cp -L repo/* _site/aarch64/; fi
          
          # Fix Signature Names
          cd _site/aarch64
          [ -f "lt-aur.db.tar.gz.sig" ] && cp lt-aur.db.tar.gz.sig lt-aur.db.sig
          
          # Index
          cd ../..
          echo "<html><body><h1>lt-aur</h1><pre>" > _site/index.html
          ls -1 _site/aarch64 >> _site/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build-arm
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
