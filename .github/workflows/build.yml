name: Build lt-aur Repo

on:
  push:
    paths:
      - 'packages-list.yaml'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-arm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in Arch ARM Container
        uses: addnab/docker-run-action@v3
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        with:
          image: agners/archlinuxarm
          options: --platform linux/arm64 -v ${{ github.workspace }}:/workspace -e GPG_PRIVATE_KEY -e GPG_PASSPHRASE
          run: |
            # --- SETUP ---
            cd /workspace
            DB_NAME="lt-aur"
            
            # Install prerequisites
            pacman-key --init
            pacman-key --populate archlinuxarm
            pacman -Syu --noconfirm base-devel git sudo
            
            # Setup Builder User
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder
            chmod 0440 /etc/sudoers.d/builder
            
            # Install aurutils
            echo "::group::Installing aurutils"
            su builder -c "cd ~ && git clone https://aur.archlinux.org/aurutils.git && cd aurutils && makepkg -si --noconfirm"
            echo "::endgroup::"
            
            # Prepare Repo Dir
            mkdir -p repo
            chown builder:builder repo
            
            # --- GPG SETUP ---
            echo "::group::Configuring GPG"
            su builder -c "mkdir -p ~/.gnupg && chmod 700 ~/.gnupg"
            su builder -c "echo 'allow-loopback-pinentry' >> ~/.gnupg/gpg-agent.conf"
            su builder -c "echo 'pinentry-mode loopback' >> ~/.gnupg/gpg.conf"
            su builder -c "gpgconf --kill gpg-agent"
            su builder -c "gpg --batch --import <(echo '$GPG_PRIVATE_KEY')"
            
            KEY_FINGERPRINT=$(su builder -c "gpg --list-secret-keys --with-colons" | grep fpr | head -n1 | cut -d: -f10)
            echo "${KEY_FINGERPRINT}:6:" | su builder -c "gpg --import-ownertrust"
            
            # Prime the agent with passphrase
            if [ ! -z "$GPG_PASSPHRASE" ]; then
               echo "test" | su builder -c "gpg --batch --yes --passphrase '$GPG_PASSPHRASE' --pinentry-mode loopback --dry-run -s"
            fi
            echo "::endgroup::"

            # Reset DB to ensure cleanliness
            rm -f repo/$DB_NAME.db*
            su builder -c "repo-add --sign --key $KEY_FINGERPRINT repo/$DB_NAME.db.tar.gz"
            
            # --- BUILD ---
            if [ ! -f packages-list.yaml ]; then echo "No package list!"; exit 1; fi
            PACKAGES=$(grep '  -' packages-list.yaml | cut -d'-' -f2- | tr -d ' ' | xargs)
            
            echo "::group::Building Packages: $PACKAGES"
            su builder -c "aur fetch $PACKAGES"
            cd /home/builder
            su builder -c "aur graph $PACKAGES" | tsort | tac > build_order.txt
            
            while read pkg; do
                echo "--> Building $pkg..."
                cd /home/builder/$pkg
                
                # Build & Sign
                su builder -c "makepkg -si --noconfirm --nocheck --sign --key $KEY_FINGERPRINT"
                
                # Move artifacts (pkg + sig)
                # CRITICAL FIX: The wildcard '*' at the end grabs the .sig file too!
                mv *.pkg.tar.zst* /workspace/repo/
                
                # Add to DB
                cd /workspace/repo
                su builder -c "repo-add --new --sign --key $KEY_FINGERPRINT --verify $DB_NAME.db.tar.gz *.pkg.tar.zst" || exit 1
            done < /home/builder/build_order.txt
            echo "::endgroup::"

      - name: Fix Permissions
        run: sudo chown -R $USER:$USER repo

      - name: Debug Repo Contents
        run: ls -la repo/

      - name: Prepare Pages Site
        run: |
          mkdir -p _site/aarch64
          cp -L repo/* _site/aarch64/
          
          # Ensure strict signature naming
          cd _site/aarch64
          [ -f "lt-aur.db.tar.gz.sig" ] && cp lt-aur.db.tar.gz.sig lt-aur.db.sig
          
          # Generate Index
          cd ../..
          echo "<html><body><h1>lt-aur</h1><ul><li><a href='aarch64/'>aarch64</a></li></ul></body></html>" > _site/index.html
          echo "<html><body><h1>/aarch64</h1><pre>" > _site/aarch64/index.html
          ls -1 _site/aarch64 >> _site/aarch64/index.html
          echo "</pre></body></html>" >> _site/aarch64/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build-arm
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
