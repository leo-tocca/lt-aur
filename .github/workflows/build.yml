name: Build ARM Repo

on:
  push:
    branches: [ main ]
    paths:
      - 'packages/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-arm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Detect Changed Packages
      - name: Get Targets
        id: targets
        run: |
          # If manual run, build ALL packages
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Manual trigger: Building all packages"
             PACKAGES=$(ls packages/ | tr '\n' ' ')
          else
             # On push, only build folders that changed
             PACKAGES=$(git diff --name-only HEAD^ HEAD | grep '^packages/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          fi

          if [ -z "$PACKAGES" ]; then
            echo "No changes detected."
            echo "defined=false" >> $GITHUB_OUTPUT
          else
            echo "Targets: $PACKAGES"
            echo "defined=true" >> $GITHUB_OUTPUT
            echo "list=$PACKAGES" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        if: steps.targets.outputs.defined == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Build in Arch ARM Container
        if: steps.targets.outputs.defined == 'true'
        uses: addnab/docker-run-action@v3
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PACKAGES: ${{ steps.targets.outputs.list }}
          REPO_URL: "https://leo-tocca.github.io/lt-aur/aarch64"
        with:
          image: agners/archlinuxarm
          # Mount workspace and pass variables
          options: --platform linux/arm64 -v ${{ github.workspace }}:/workspace -e GPG_PRIVATE_KEY -e GPG_PASSPHRASE -e PACKAGES -e REPO_URL
          run: |
            # --- SYSTEM SETUP ---
            cd /workspace
            DB_NAME="lt-aur"
            mkdir -p repo
            
            # 1. Update Keyring & Mirrors (Crucial for ARM)
            echo "::group::System Update"
            pacman-key --init
            pacman-key --populate archlinuxarm
            # Refresh mirrorlist to ensure we can download dependencies
            pacman -Syu --noconfirm base-devel git sudo wget || echo "Mirror update failed, trying to continue..."
            echo "::endgroup::"
            
            # 2. Setup Builder User
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builder
            chmod 0440 /etc/sudoers.d/builder
            chown -R builder:builder repo

            # --- GPG SETUP ---
            echo "::group::Configuring GPG"
            su builder -c "mkdir -p ~/.gnupg && chmod 700 ~/.gnupg"
            su builder -c "echo 'allow-loopback-pinentry' >> ~/.gnupg/gpg-agent.conf"
            su builder -c "echo 'pinentry-mode loopback' >> ~/.gnupg/gpg.conf"
            su builder -c "gpgconf --kill gpg-agent"
            # Import Key
            su builder -c "gpg --batch --import <(echo '$GPG_PRIVATE_KEY')"
            KEY_FINGERPRINT=$(su builder -c "gpg --list-secret-keys --with-colons" | grep fpr | head -n1 | cut -d: -f10)
            echo "${KEY_FINGERPRINT}:6:" | su builder -c "gpg --import-ownertrust"
            
            # Prime Agent (Fixes password prompt issues)
            if [ ! -z "$GPG_PASSPHRASE" ]; then
               echo "test" | su builder -c "gpg --batch --yes --passphrase '$GPG_PASSPHRASE' --pinentry-mode loopback --dry-run -s --armor"
            fi
            echo "::endgroup::"

            # --- DOWNLOAD EXISTING DB ---
            echo "::group::Fetching existing repo"
            cd repo
            # Try to get existing DB so we don't wipe old packages
            if wget -q "$REPO_URL/$DB_NAME.db.tar.gz"; then
                echo "✅ Existing database found."
                wget -q "$REPO_URL/$DB_NAME.db.tar.gz.sig" || true
            else
                echo "⚠️ No database found. Starting fresh."
                su builder -c "repo-add --sign --key $KEY_FINGERPRINT $DB_NAME.db.tar.gz"
            fi
            cd ..
            echo "::endgroup::"

            # --- BUILD LOOP ---
            for pkg in $PACKAGES; do
                # 1. Validate Directory
                if [ ! -d "packages/$pkg" ]; then
                    echo "Skipping $pkg (Folder missing)"
                    continue
                fi
                
                echo "--------------------------------------"
                echo "Building: $pkg"
                echo "--------------------------------------"
                
                # 2. Prepare Source
                # Copy to builder home to avoid permission errors with mounted volume
                rm -rf "/home/builder/$pkg"
                cp -r "packages/$pkg" "/home/builder/$pkg"
                chown -R builder:builder "/home/builder/$pkg"
                cd "/home/builder/$pkg"
                
                # 3. BUILD
                # makepkg -s (sync deps) -i (install deps)
                # If dependencies are missing from ARM repo, this will fail.
                su builder -c "makepkg -si --noconfirm --nocheck --sign --key $KEY_FINGERPRINT"
                
                if [ $? -ne 0 ]; then
                    echo "❌ FAILED to build $pkg"
                    # We exit to stop the pipeline, or remove 'exit 1' to continue to next pkg
                    exit 1
                fi

                # 4. Save Artifacts
                # Move package AND signature to repo
                mv *.pkg.tar.zst* /workspace/repo/
                
                # 5. Update Database
                cd /workspace/repo
                echo "Adding to database..."
                su builder -c "repo-add --new --sign --key $KEY_FINGERPRINT --verify $DB_NAME.db.tar.gz *.pkg.tar.zst"
            done

      - name: Fix Permissions
        if: always()
        run: sudo chown -R $USER:$USER repo

      - name: Prepare Pages
        if: steps.targets.outputs.defined == 'true'
        run: |
          mkdir -p _site/aarch64
          if [ -d "repo" ]; then cp -L repo/* _site/aarch64/; fi
          
          # Fix Signature Name for Pacman
          cd _site/aarch64
          [ -f "lt-aur.db.tar.gz.sig" ] && cp lt-aur.db.tar.gz.sig lt-aur.db.sig
          
          # Index
          cd ../..
          echo "<h1>lt-aur</h1>" > _site/index.html
          echo "<pre>" > _site/aarch64/index.html
          ls -1 _site/aarch64 >> _site/aarch64/index.html

      - name: Upload Pages
        if: steps.targets.outputs.defined == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build-arm
    if: needs.build-arm.outputs.defined == 'true'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
