name: Build Packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
  repository_dispatch:
    types: [packages-updated]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changed.outputs.packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed packages
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            packages=$(ls -1 packages | jq -R -s -c 'split("\n")[:-1]')
          else
            packages=$(git diff --name-only HEAD~1 HEAD | \
              grep '^packages/' | \
              cut -d'/' -f2 | \
              sort -u | \
              jq -R -s -c 'split("\n")[:-1]')
          fi
          echo "packages=$packages" >> $GITHUB_OUTPUT
          echo "Changed packages: $packages"

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.packages != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.packages) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build package (Arch Linux ARM)
        run: |
          mkdir -p output
          docker run --rm --platform linux/arm64 \
            -v $(pwd)/packages/${{ matrix.package }}:/build \
            -v $(pwd)/output:/output \
            danhunsaker/archlinuxarm \
            bash -euxo pipefail <<'EOF'
          pacman -Syu --noconfirm base-devel git sudo
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          cd /build
          chown -R builder:builder .

          su builder -c "makepkg -s --clean --noconfirm"

          mv *.pkg.tar.zst /output/
          EOF

      - name: Check build output
        run: |
          ls -lah output/
          test -f output/*.pkg.tar.zst

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-keys

      - name: Sign packages
        run: |
          cd output
          for pkg in *.pkg.tar.zst; do
            echo "${{ secrets.GPG_PASSPHRASE }}" | \
              gpg --batch --yes --passphrase-fd 0 \
              --detach-sign --armor "$pkg"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.package }}
          path: output/*
          retention-days: 7

  create-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: pkg-*
          merge-multiple: true

      - name: Prepare release
        id: prep
        run: |
          echo "tag=repo-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.prep.outputs.tag }}
          name: Binary repo ${{ steps.prep.outputs.tag }}
          files: artifacts/*
          body: |
            Automated ARM build.
            Packages: ${{ needs.detect-changes.outputs.packages }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-database:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Download latest release packages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir repo
          tag=$(gh release list -R ${{ github.repository }} --limit 1 | awk '{print $1}')
          gh release download "$tag" -R ${{ github.repository }} -p "*.pkg.tar.zst" -D repo

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Create repository database (ARM)
        run: |
          docker run --rm --platform linux/arm64 \
            -v $(pwd)/repo:/repo \
            danhunsaker/archlinuxarm \
            bash -euxo pipefail <<'EOF'
          pacman -Sy --noconfirm pacman
          cd /repo
          repo-add -s -k "${{ secrets.GPG_KEY_ID }}" \
            --verify --sign \
            lt-aur.db.tar.gz *.pkg.tar.zst
          EOF

      - name: Upload database to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag=$(gh release list -R ${{ github.repository }} --limit 1 | awk '{print $1}')
          gh release upload "$tag" -R ${{ github.repository }} \
            repo/lt-aur.db.tar.gz \
            repo/lt-aur.files.tar.gz \
            --clobber
